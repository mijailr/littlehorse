<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-architecture-and-guarantees" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">Architecture and Guarantees | LittleHorse Orchestrator</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://littlehorse.dev/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://littlehorse.dev/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://littlehorse.dev/docs/architecture-and-guarantees"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Architecture and Guarantees | LittleHorse Orchestrator"><meta data-rh="true" name="description" content="LittleHorse is a horizontally scalable, high-performance system with enterprise-grade security integrations to help you build systems that support even the most mission-critical workloads."><meta data-rh="true" property="og:description" content="LittleHorse is a horizontally scalable, high-performance system with enterprise-grade security integrations to help you build systems that support even the most mission-critical workloads."><link data-rh="true" rel="icon" href="/img/logo.png"><link data-rh="true" rel="canonical" href="https://littlehorse.dev/docs/architecture-and-guarantees"><link data-rh="true" rel="alternate" href="https://littlehorse.dev/docs/architecture-and-guarantees" hreflang="en"><link data-rh="true" rel="alternate" href="https://littlehorse.dev/docs/architecture-and-guarantees" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://G6OXK45P4J-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="LittleHorse Orchestrator RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="LittleHorse Orchestrator Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1DL56CH5SS"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-1DL56CH5SS",{})</script>
<link rel="preconnect" href="https://www.googletagmanager.com">
<script>window.dataLayer=window.dataLayer||[]</script>
<script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-NCK3N2PC",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script>


<link rel="search" type="application/opensearchdescription+xml" title="LittleHorse Orchestrator" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.6a49480f.css">
<script src="/assets/js/runtime~main.aa528b23.js" defer="defer"></script>
<script src="/assets/js/main.be4c3183.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NCK3N2PC" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo-brown.png" alt="LittleHorse Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="LittleHorse Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">LittleHorse</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/overview">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a href="https://littlehorse.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Product Site<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="https://docs.google.com/forms/d/e/1FAIpQLScXVvTYy4LQnYoFoRKRQ7ppuxe0KgncsDukvm96qKN0pU5TnQ/viewform?usp=sf_link" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Contact Us<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/littlehorse-enterprises/littlehorse" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><a href="https://launchpass.com/littlehorsecommunity" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-slack-link"></a><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/architecture-and-guarantees">Architecture and Guarantees</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/concepts/">Concepts</a><button aria-label="Expand sidebar category &#x27;Concepts&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/developer-guide/">Developer Guide</a><button aria-label="Expand sidebar category &#x27;Developer Guide&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/operations/">Operations</a><button aria-label="Expand sidebar category &#x27;Operations&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/api">LittleHorse API Reference</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Architecture and Guarantees</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Architecture and Guarantees</h1>
<p>LittleHorse is a horizontally scalable, high-performance system with enterprise-grade security integrations to help you build systems that support even the most mission-critical workloads.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture-overview">Architecture Overview<a href="#architecture-overview" class="hash-link" aria-label="Direct link to Architecture Overview" title="Direct link to Architecture Overview">​</a></h2>
<p>LittleHorse is a distributed system. That means that we have:</p>
<ul>
<li><strong>Partitioning</strong>, to distribute work across multiple servers for horizontal scalability.</li>
<li><strong>Replication</strong>, to ensure high availability and durability in case a server instance crashes.</li>
</ul>
<p>For performance reasons, LittleHorse does not rely upon an external database. Instead, we built our own data store using Kafka as a write-ahead-log and using RocksDB/Speedb as our indexing layer. Kafka is a distributed log that supports partitioning, replication, and transactions, making it ideal as the backbone for the LittleHorse data store.</p>
<p>As such, LittleHorse has a dependency on Kafka. We have <em>optional</em> integrations with Prometheus, Grafana, any TLS system (such as openssl or Cert Manager), and any OAuth Identity Provider (eg. Keycloak or Auth0).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deployment-options">Deployment Options<a href="#deployment-options" class="hash-link" aria-label="Direct link to Deployment Options" title="Direct link to Deployment Options">​</a></h3>
<p>There are three main physical components in a LittleHorse System:</p>
<ol>
<li>The LittleHorse Server.</li>
<li>Task Workers.</li>
<li>LittleHorse Clients (either <code>lhctl</code> or a client using one of our SDK&#x27;s).</li>
</ol>
<p>The Clients create and manage metadata objects, such as <code>TaskDef</code>s and <code>WfSpec</code>s. The Clients also run workflows using the <code>RunWf</code> grpc call. The Task Workers connect to the LittleHorse Server, and the LittleHorse Server dispatches tasks to be executed by the Task Workers.</p>
<p>The Task Workers and Clients are owned and deployed by you, the user of LittleHorse. The LittleHorse Server does not initiate any outbound connections to your Task Workers or Clients. Additionally, your Task Workers and Clients can run anywhere so long as they have network access to the LH Server.</p>
<p>The LittleHorse Server can be deployed in one of three ways: LittleHorse OSS, LittleHorse for Kubernetes, and LittleHorse Cloud.</p>
<!-- -->
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">LH OSS</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">LH for Kubernetes</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">LH Cloud</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p>As the LH Server is source-available under the SSPL 1.0 license, you can run LittleHorse free of charge in production on your own infrastructure. You can get the code from our <a href="https://github.com/littlehorse-enterprises/littlehorse" target="_blank" rel="noopener noreferrer">GitHub Repo</a>, and our repo has quickstart tutorials for running LittleHorse using our public docker image.</p><p>LittleHorse OSS is licensed under the <a href="https://www.mongodb.com/licensing/server-side-public-license" target="_blank" rel="noopener noreferrer">Server Side Public License</a>. Mongo has a fantastic <a href="https://www.mongodb.com/licensing/server-side-public-license/faq" target="_blank" rel="noopener noreferrer">SSPL FAQ</a>. The TLDR of the license is that you can use LittleHorse OSS for free in production without restriction unless you are offering LittleHorse-as-a-Service to external organizations.</p><p>For information on how to run LittleHorse OSS in production, check out our <a href="/docs/operations/">Operations Documentation</a>.</p><p><img decoding="async" loading="lazy" alt="LH OSS logo" src="/assets/images/logo-41ece11b57b8bdc87d2a631a2b4e676e.jpg" width="2000" height="1000" class="img_ev3q"></p><div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>If you are building a software application delivered over the internet (SaaS), you may do so without restriction even if your SaaS app is <em>powered by</em> LittleHorse.</p><p>A SaaS application qualifies as &quot;powered by LittleHorse&quot; so long as the end product used by customers has a meaningfully differentiated API from the core LH Server Public GRPC API. For example, you can sell an e-commerce application that runs on LittleHorse OSS without restriction.</p><p>However, if a company explicitly exposes the entire LH Server Public GRPC API as a SaaS service, then Section 13 of the SSPL would apply.</p></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>LittleHorse for Kubernetes (LHK) is an enterprise-ready managed installation of LittleHorse in your Kubernetes cluster. It is delivered through a subscription to a Kubernetes Operator, which takes LittleHorse from a stick-shift car (LH OSS) and turns it into a Tesla.</p><p>LHK is suitable for large enterprises who have strict data privacy and security requirements, and who are uncomfortable with allowing data to leave their four walls. LH Platform is highly configurable, yet it is also simple and comes with sensible defaults, 24/7 support, and hands-off upgrades.</p><p><img decoding="async" loading="lazy" alt="LH for Kubernetes Overview" src="/assets/images/lh-for-kubernetes-7f745f022b7a3b5d0cc2074799aacce4.png" width="3199" height="2404" class="img_ev3q"></p><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>To inquire about LittleHorse for Kubernetes, fill out the <a href="https://docs.google.com/forms/d/e/1FAIpQLScXVvTYy4LQnYoFoRKRQ7ppuxe0KgncsDukvm96qKN0pU5TnQ/viewform?usp=sf_link" target="_blank" rel="noopener noreferrer">waitlist form</a> or contact <code>sales@littlehorse.io</code>.</p></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>In LittleHorse Cloud, all of the operational burden of running LittleHorse is handled for you. A team of experts runs LittleHorse securely in our cloud environment, allowing you to focus on your business processes. We will support several flavors of LH Cloud:</p><ul>
<li>Standard: serverless, pay-as-you-go offereing.</li>
<li>Reserved: save money by reserving capacity up-front.</li>
<li>Dedicated: maximum-security, dedicated installation with VPC peering into your own account.</li>
</ul><p><img decoding="async" loading="lazy" alt="LH Cloud Overview" src="/assets/images/lh-cloud-017bb558e186fd570785059dfa5f2c7d.png" width="2964" height="2106" class="img_ev3q"></p><div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>To inquire about LittleHorse Platform, fill out the <a href="https://docs.google.com/forms/d/e/1FAIpQLScXVvTYy4LQnYoFoRKRQ7ppuxe0KgncsDukvm96qKN0pU5TnQ/viewform?usp=sf_link" target="_blank" rel="noopener noreferrer">waitlist form</a> or contact <code>sales@littlehorse.io</code>. LittleHorse Cloud is expected for early access in March 2024.</p></div></div></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="security">Security<a href="#security" class="hash-link" aria-label="Direct link to Security" title="Direct link to Security">​</a></h3>
<p>The LittleHorse Server supports various security mechanisms:</p>
<ul>
<li>TLS to encrypt incoming connections.</li>
<li>Federated identity for authentication (either mTLS or OAuth).</li>
<li>mTLS to secure inter-server communication.</li>
</ul>
<p>LittleHorse for Kubernetes has integrations with the Gateway API, Cert Manager, and Keycloak. Additionally, since LH Platform runs entirely in your own network, your firewall rules can add an additional layer of security.</p>
<p>LittleHorse Cloud uses TLS and OAuth for client authentication, and SSO for access to the LH Dashboard.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture-internals">Architecture Internals<a href="#architecture-internals" class="hash-link" aria-label="Direct link to Architecture Internals" title="Direct link to Architecture Internals">​</a></h2>
<p>Recall that LittleHorse built its own data store RocksDB/Speedb as the indexing layer and Kafka as a WAL (all through <a href="https://kafka.apache.org/documentation/streams/" target="_blank" rel="noopener noreferrer">Kafka Streams</a>). The request processing flow has two phases:</p>
<ol>
<li>The request is recorded to a Kafka topic.</li>
<li>A Kafka Streams Processor on one of the LH Servers processes that request, at which point the response is returned to the client.</li>
</ol>
<p><img decoding="async" loading="lazy" alt="Command Processing Diagram" src="/assets/images/command-processing-75411a029c01d44dbaeaa5698a762bda.png" width="4140" height="2202" class="img_ev3q"></p>
<ol>
<li>Client sends request (eg. Create Workflow Specification)
to LH Server.</li>
<li>LH Server records the request (along with a Request Guid) to the core command Kafka Topic (<code>2a</code>). LH Server contacts the designated Command Processor and asks to wait for the response for the Request Guid (<code>2b</code>).</li>
<li>The Command Processor processes the Command after reading it from the Core Command Topic.</li>
<li>The Command Processor updates the state (eg. create the <code>WfRun</code> Object) in the RocksDB State Store (<code>4a</code>). The Command Processor notifies the original calling LH Server of the results of the processing (<code>4b</code>).</li>
<li>The LH Server sends the results back to the client.</li>
</ol>
<p>Because the data is stored in RocksDB on the same disk as where the processing happens, we can achieve extremely high throughput. One single partition of LittleHorse can schedule and process over 1,000 <code>TaskRun</code>s per second, which means 3,000 requests being processed per second on one partition.</p>
<p>The latency of a request is normally under 20ms, depending on your LH Server configuration.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-is-data-stored">How is Data Stored?<a href="#how-is-data-stored" class="hash-link" aria-label="Direct link to How is Data Stored?" title="Direct link to How is Data Stored?">​</a></h3>
<p>As mentioned above, we use RocksDB as the backbone for our custom data store. All read operations (eg. <code>rpc GetWfRun</code>, <code>rpc SearchVariable</code>) read directly from the RocksDB Stores in LittleHorse. Note that a RocksDB store is an embedded key-value store and does not natively provide replication. However, since these stores are managed through Kafka Streams, they are backed by a durable and replicated Kafka Changelog Topic. All writes and deletes to the RocksDB stores are first written to a Kafka Changelog Topic to provide durability and recovery in the case of a crash.</p>
<p>As such, data is written to two places:</p>
<ul>
<li>The RocksDB instances, stored on disk on the LH Servers.</li>
<li>The Kafka Changelog Topic, stored on disk in the backing Kafka cluster.</li>
</ul>
<p>When data is removed (eg. <code>rpc DeleteWfRun</code>), the records are removed from RocksDB, and a tombstone is written to the Kafka Changelog Topic so that the data is completely erased once Kafka Log Compaction is triggered.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-streams-topologies">Kafka Streams Topologies<a href="#kafka-streams-topologies" class="hash-link" aria-label="Direct link to Kafka Streams Topologies" title="Direct link to Kafka Streams Topologies">​</a></h3>
<p>Internally, LittleHorse has two Kafka Streams <code>Topology</code>&#x27;s and a total of four Sub-Topologies. If you want to check it out in the code, the file you want is <a href="https://github.com/littlehorse-enterprises/littlehorse/blob/0.7.0/server/src/main/java/io/littlehorse/server/streams/ServerTopology.java" target="_blank" rel="noopener noreferrer"><code>ServerTopology.java</code></a>. A basic overview of the roles of each sub-topology can be found below.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="metadata-sub-topology">Metadata Sub-Topology<a href="#metadata-sub-topology" class="hash-link" aria-label="Direct link to Metadata Sub-Topology" title="Direct link to Metadata Sub-Topology">​</a></h4>
<p>The Metadata Sub-Topology is responsible for processing and storing udpates to metadata such as <code>WfSpec</code>, <code>TaskDef</code>, <code>ExternalEventDef</code>, and <code>UserTaskDef</code> objects. When you make an RPC call that impacts metadata (eg. <code>rpc PutWfSpec</code>), the resulting <code>Command</code> is processed on the Metadata Topology.</p>
<p>Because metadata depend on each other (i.e. a <code>PutWfSpecRequest</code> should fail if the <code>WfSpec</code> references a non-existent <code>TaskDef</code>), the input topic to the Metadata Sub-Topology has a single partition.</p>
<p>The metadata objects are required by other sub-topologies, so they are broadcast as a Kafka Streams Global Store which is available for read-only access on other processors.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="core-sub-topology">Core Sub-Topology<a href="#core-sub-topology" class="hash-link" aria-label="Direct link to Core Sub-Topology" title="Direct link to Core Sub-Topology">​</a></h4>
<p>The Core Sub-Topology is where most of the LittleHorse work happens. All state for a <code>WfRun</code>, <code>NodeRun</code>, <code>TaskRun</code>, <code>UserTaskRun</code>, etc is processed and stored on the Core Sub-Topology. For example, the <code>rpc RunWf</code> request sends a <code>Command</code> that is routed to this Sub-Topology, and the <code>rpc GetWfRun</code> request performs a hashed key-value lookup on this sub-topology.</p>
<p>This Sub-Topology also stores some index information related to the <code>WfRun</code>s. This Sub-Topology has the heaviest workload in terms of state and data processing.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="repartitioned-sub-topology">Repartitioned Sub-Topology<a href="#repartitioned-sub-topology" class="hash-link" aria-label="Direct link to Repartitioned Sub-Topology" title="Direct link to Repartitioned Sub-Topology">​</a></h4>
<p>Refered to as the <code>Repartition</code> topology inside our code, this sub-topology is responsible for aggregating metrics and also storing some types of indexes. This sub-topology stores much less state than the Core Sub-Topology and also has less processing throughput.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="timer-topology">Timer Topology<a href="#timer-topology" class="hash-link" aria-label="Direct link to Timer Topology" title="Direct link to Timer Topology">​</a></h4>
<p>Lastly, we have a timer service which runs as its own Kafka Streams <code>Topology</code> due to different configuration requirements. When the LittleHorse Scheduler (generally, in the Core Sub-Topology) needs to schedule some action with a delay, it sends a <code>LHTimer</code> event to the Timer Topology. The Timer Topology will then send the requested payload in the form of a <code>Command</code> back into the Core Sub-Topology at the specified time.</p>
<p>For example, when a <code>TaskRun</code> is started by a Task Worker (let&#x27;s say the configured Task Timeout is 15 seconds), the Core Sub-Topology sends an <code>LHTimer</code> with a <code>TaskRunTimeout</code> payload and delay of 15 seconds. Then, 15 seconds later, the Timer Topology sends the <code>TaskRunTimeout</code> payload into the Core Sub-Topology.</p>
<p>Separating it into a different topology rather than using a punctuator was necessary for several reasons:</p>
<ul>
<li>Strong ordering during backpressure situations.</li>
<li>Performance: punctuators block processing of <code>Command</code>s.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="guarantees">Guarantees<a href="#guarantees" class="hash-link" aria-label="Direct link to Guarantees" title="Direct link to Guarantees">​</a></h2>
<p>LittleHorse provides certain guarantees which can help you build reliable and correct applications. These are important to understand when designing mission-critical applications.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fault-tolerance">Fault Tolerance<a href="#fault-tolerance" class="hash-link" aria-label="Direct link to Fault Tolerance" title="Direct link to Fault Tolerance">​</a></h3>
<p>In order to provide high availability and durability, LittleHorse Platform and LittleHorse Cloud synchronously replicate all data across three Availability Zones. Before an event (such as a request to run a <code>WfRun</code>) can be processed by a LH Server, it first must be accepted by Kafka Brokers on two of the three Availability Zones.</p>
<p>This provides three neat results in the face of an outage (whether one server or a whole datacenter):</p>
<ol>
<li>We do not experience data loss.</li>
<li>We can continue processing <code>WfRun</code>s after a short rebalance period, between 10-30 seconds depending on your LH Server configuration.</li>
</ol>
<p>Since LittleHorse requires two acknowledgements before accepting an event, it is possible that some partitions of the system will become unavailable if physical machines fail in two datacenters as LittleHorse is a CP system (prioritizing consistency over availability).</p>
<p>LittleHorse OSS can provide the same guarantees if both the LH Server and the backing Kafka cluster are properly configured.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="strongly-consistent-scheduling">Strongly Consistent Scheduling<a href="#strongly-consistent-scheduling" class="hash-link" aria-label="Direct link to Strongly Consistent Scheduling" title="Direct link to Strongly Consistent Scheduling">​</a></h3>
<p>When a <code>WfRun</code> reaches a <code>TASK</code> node, LittleHorse schedules a <code>TaskRun</code> and thereby returns a <code>ScheduledTask</code> payload to one of the Task Workers polling for such a task.</p>
<p><strong>LittleHorse guarantees <em>at-most-once</em> delivery of a <code>ScheduledTask</code>.</strong> This means that LittleHorse will never return the same <code>ScheduledTask</code> twice to the Task Workers. However, if there is a network partition between the Task Workers and the LittleHorse Servers, it is possible that LittleHorse thinks the task has been scheduled but the Task Workers never receive it.</p>
<p>If you want to achieve at-least-once delivery of a task, you can achieve that by configuring retries for that Task Node. If the Task is not delivered to the Task Workers, then the task will fail with a timeout error and be retried.</p>
<p>Effectively-once processing can be achieved if you can design your Task Worker to be idempotent. The steps to achieve this are:</p>
<ol>
<li>Enable multiple retries for your task.</li>
<li>Use the idempotency id for the <code>ScheduledTask</code> to ensure that your Task is idempotent (for examples, see the Developer Guide).</li>
</ol>
<p><em>NOTE: Providing exactly-once delivery without some form of 2-phase commit is impossible due to the laws of physics.</em></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="idempotency-of-requests">Idempotency of Requests<a href="#idempotency-of-requests" class="hash-link" aria-label="Direct link to Idempotency of Requests" title="Direct link to Idempotency of Requests">​</a></h3>
<p>Requests made to the grpc in LittleHorse can be safely retried through idempotency.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Note that retries of a <code>TaskRun</code> are a separate concept from retries on grpc requests made by LittleHorse clients. A <code>TaskRun</code> retry causes another <code>ScheduledTask</code> to be sent to a Task Worker by the LittleHorse Server; in contrast, this section discusses what happens when a client retries a request made to the LH Server grpc api.</p></div></div>
<p>In LittleHorse, some requests are idempotent by default, meaning they can be safely retried indefinitely. For example:</p>
<ul>
<li>All <code>Delete</code> requests are idempotent.</li>
<li>All requests made by the Task Worker are idempotent.</li>
<li>All requests related to assigning, cancelling, or completing a <code>UserTask</code> are idempotent by default.</li>
<li>All requests to create <code>TaskDef</code> or <code>ExternalEventDef</code> metadata are idempotent by default.</li>
</ul>
<p>Additionally, <strong>all <code>WfRun</code>-related requests in LittleHorse can be made idempotent with proper configuration.</strong> For example:</p>
<ul>
<li>If you pass an <code>id</code> in a <code>RunWf</code> rpc call, you can safely retry the request indefinitely, and only one <code>WfRun</code> is created.</li>
<li>If you pass a <code>guid</code> in a <code>PutExternalEvent</code> rpc call, you can safely retry the request indefinitely, and only one <code>ExternalEvent</code> will be created.</li>
</ul>
<p>Lastly, some metadata requests are partially idempotent. If you specify a <code>version</code> in a <code>PutWfSpec</code> or <code>PutUserTaskDef</code> request, the request can be safely retried indefinitely. Without specifying a <code>version</code>, retried requests will result in identical <code>WfSpec</code> or <code>UserTaskDef</code> objects being created, which does not affect business logic.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="non-wfrun-data">Non-<code>WfRun</code> Data<a href="#non-wfrun-data" class="hash-link" aria-label="Direct link to non-wfrun-data" title="Direct link to non-wfrun-data">​</a></h3>
<p>All data related to <code>WfRun</code> processing is strongly consistent. However, like other systems such as Kafka, changes to metadata (<code>WfSpec</code>, <code>TaskDef</code>, <code>ExternalEventDef</code>, <code>UserTaskDef</code>) are eventually-consistent.</p>
<p>Upon creating or deleting a metadata object, news of the change can take up to 300ms to propagate to all LittleHorse Server Instances. However, this is acceptable since updates to metadata objects are infrequent. In production, we recommend a Git-Ops approach for deploying changes to metadata, just like deploying changes to microservices.</p>
<p>Additionally, certain indexes on <code>Variable</code>s are eventually consistent and can be delayed by up to 200ms. However, all indexes in LittleHorse are exclusively used for read-only observability requests and are not used by the scheduler when making decisions about workflow scheduling. As such, <strong>all <code>WfRun</code> scheduling in LittleHorse is strongly consistent.</strong></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/overview"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Overview</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/concepts/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Concepts</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#architecture-overview" class="table-of-contents__link toc-highlight">Architecture Overview</a><ul><li><a href="#deployment-options" class="table-of-contents__link toc-highlight">Deployment Options</a></li><li><a href="#security" class="table-of-contents__link toc-highlight">Security</a></li></ul></li><li><a href="#architecture-internals" class="table-of-contents__link toc-highlight">Architecture Internals</a><ul><li><a href="#how-is-data-stored" class="table-of-contents__link toc-highlight">How is Data Stored?</a></li><li><a href="#kafka-streams-topologies" class="table-of-contents__link toc-highlight">Kafka Streams Topologies</a></li></ul></li><li><a href="#guarantees" class="table-of-contents__link toc-highlight">Guarantees</a><ul><li><a href="#fault-tolerance" class="table-of-contents__link toc-highlight">Fault Tolerance</a></li><li><a href="#strongly-consistent-scheduling" class="table-of-contents__link toc-highlight">Strongly Consistent Scheduling</a></li><li><a href="#idempotency-of-requests" class="table-of-contents__link toc-highlight">Idempotency of Requests</a></li><li><a href="#non-wfrun-data" class="table-of-contents__link toc-highlight">Non-<code>WfRun</code> Data</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/concepts">Concepts</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/developer-guide">Developer Guide</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://launchpass.com/littlehorsecommunity" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/littlehorse-enterprises/littlehorse" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 LittleHorse Enterprises LLC.</div></div></div></footer></div>
</body>
</html>